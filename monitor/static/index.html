<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bluesky Stream Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #0a0a0a;
        color: #e0e0e0;
        min-height: 100vh;
        padding: 2rem;
      }
      .header {
        text-align: center;
        margin-bottom: 2rem;
      }
      .header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .header p {
        color: #666;
        font-size: 0.875rem;
      }
      .live-counters {
        display: flex;
        flex-wrap: nowrap;
        gap: 1rem;
        justify-content: center;
        align-items: stretch;
        margin: 0 auto 3rem auto;
        max-width: 800px;
      }
      .session-label {
        width: 100%;
        text-align: center;
        font-size: 0.75rem;
        color: #555;
        margin-bottom: 0.25rem;
        flex-shrink: 0;
      }
      .counter {
        background: #1a1a1a;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        border: 1px solid #333;
        flex: 1 1 0;
        min-width: 0;
      }
      .counter .label {
        font-size: 0.875rem;
        color: #888;
        margin-bottom: 0.5rem;
      }
      .counter .value {
        font-size: 2.5rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
      }
      .counter .rate {
        font-size: 1rem;
        color: #666;
        margin-top: 0.5rem;
      }
      .delta {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem 2rem;
        flex: 0 0 140px;
        min-width: 240px;
      }
      .delta .value {
        font-variant-numeric: tabular-nums;
      }
      .delta .label {
        font-size: 0.75rem;
        color: #666;
      }
      .delta .value {
        font-size: 2rem;
        font-weight: 600;
      }
      .delta.positive .value {
        color: #4ade80;
      }
      .delta.negative .value {
        color: #f87171;
      }
      .delta.neutral .value {
        color: #888;
      }
      .charts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }
      .chart-panel {
        background: #1a1a1a;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #333;
        flex: 1 1 calc(50% - 1rem);
        min-width: 0;
      }
      .chart-panel h2 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #888;
      }
      .chart-wrapper {
        height: 300px;
        position: relative;
      }
      .status {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        background: #1a1a1a;
        border: 1px solid #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .status .duration {
        font-size: 0.65rem;
        color: #666;
      }
      .status.connected {
        color: #4ade80;
      }
      .status.disconnected {
        color: #f87171;
      }
      @media (max-width: 900px) {
        body {
          padding: 1rem;
        }
        .charts-container {
          flex-direction: column;
          gap: 1rem;
        }
        .chart-panel {
          flex: 1 1 100%;
          min-width: 0;
          padding: 1rem;
        }
        .chart-wrapper {
          height: 250px;
        }
        .live-counters {
          flex-direction: column;
          gap: 1rem;
        }
        .counter,
        .delta {
          flex: 1 1 100%;
          width: 100%;
        }
        .delta {
          padding: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Stream Monitor</h1>
        <p>Session totals Â· Comparing Bluesky turbo streams</p>
    </div>

    <div class="live-counters">
      <div class="session-label">During this browser session</div>
      <div class="counter">
        <div class="label" id="label-a">Stream A</div>
        <div class="value" id="count-a">0</div>
        <div class="rate" id="rate-a">0/s</div>
      </div>
      <div class="delta neutral" id="delta">
        <div class="label">Delta</div>
        <div class="value" id="delta-value">0</div>
      </div>
      <div class="counter">
        <div class="label" id="label-b">Stream B</div>
        <div class="value" id="count-b">0</div>
        <div class="rate" id="rate-b">0/s</div>
      </div>
    </div>

    <div class="charts-container">
      <div class="chart-panel">
        <h2>Real-Time (24h)</h2>
        <div class="chart-wrapper">
          <canvas id="chart-24h"></canvas>
        </div>
      </div>
      <div class="chart-panel">
        <h2>Historical (28 days)</h2>
        <div class="chart-wrapper">
          <canvas id="chart-28d"></canvas>
        </div>
      </div>
    </div>

    <div class="status disconnected" id="status">
      <span class="indicator">Disconnected</span>
      <span class="duration" id="status-duration"></span>
    </div>

    <script>
      const labelA = document.getElementById("label-a");
      const labelB = document.getElementById("label-b");
      const countA = document.getElementById("count-a");
      const countB = document.getElementById("count-b");
      const rateA = document.getElementById("rate-a");
      const rateB = document.getElementById("rate-b");
      const deltaEl = document.getElementById("delta");
      const deltaValue = document.getElementById("delta-value");
      const statusEl = document.getElementById("status");
      const statusIndicator = statusEl.querySelector(".indicator");
      const statusDuration = document.getElementById("status-duration");

      let connectedAt = null;

      function formatDuration(ms) {
        const secs = Math.floor(ms / 1000);
        const mins = Math.floor(secs / 60);
        if (mins > 0) {
          return `${mins}m ${secs % 60}s`;
        }
        return `${secs}s`;
      }

      setInterval(() => {
        if (connectedAt) {
          statusDuration.textContent = formatDuration(Date.now() - connectedAt);
        }
      }, 1000);

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        plugins: {
          legend: {
            position: "top",
            labels: { color: "#888", font: { size: 11 } },
          },
          tooltip: {
            backgroundColor: "#2a2a2a",
            titleColor: "#e0e0e0",
            bodyColor: "#888",
          },
        },
        scales: {
          x: {
            ticks: { color: "#666", maxTicksLimit: 8 },
            grid: { color: "#222" },
          },
          y: {
            ticks: { color: "#666" },
            grid: { color: "#222" },
          },
        },
      };

      const chart24h = new Chart(document.getElementById("chart-24h"), {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Stream A",
              data: [],
              borderColor: "#3b82f6",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              fill: false,
              tension: 0.1,
              pointRadius: 0,
            },
            {
              label: "Stream B",
              data: [],
              borderColor: "#8b5cf6",
              backgroundColor: "rgba(139, 92, 246, 0.1)",
              fill: false,
              tension: 0.1,
              pointRadius: 0,
            },
            {
              label: "Delta",
              data: [],
              borderColor: "#4ade80",
              backgroundColor: "rgba(74, 222, 128, 0.1)",
              fill: false,
              tension: 0.1,
              pointRadius: 0,
              borderDash: [5, 5],
            },
          ],
        },
        options: chartOptions,
      });

      const chart28d = new Chart(document.getElementById("chart-28d"), {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Stream A",
              data: [],
              borderColor: "#3b82f6",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              fill: false,
              tension: 0.1,
              pointRadius: 0,
            },
            {
              label: "Stream B",
              data: [],
              borderColor: "#8b5cf6",
              backgroundColor: "rgba(139, 92, 246, 0.1)",
              fill: false,
              tension: 0.1,
              pointRadius: 0,
            },
            {
              label: "Delta",
              data: [],
              borderColor: "#4ade80",
              backgroundColor: "rgba(74, 222, 128, 0.1)",
              fill: false,
              tension: 0.1,
              pointRadius: 0,
              borderDash: [5, 5],
            },
          ],
        },
        options: chartOptions,
      });

      async function fetchHistory(hours, chart) {
        try {
          const res = await fetch(`/api/history?hours=${hours}`);
          const data = await res.json();

          const labels = data.map((d) => {
            const date = new Date(d.hour);
            return hours <= 48
              ? date.toLocaleString("en-US", {
                  month: "short",
                  day: "numeric",
                  hour: "2-digit",
                })
              : date.toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                });
          });

          chart.data.labels = labels;
          chart.data.datasets[0].data = data.map((d) => d.stream_a_count);
          chart.data.datasets[1].data = data.map((d) => d.stream_b_count);
          chart.data.datasets[2].data = data.map((d) => d.delta);
          chart.update("none");
        } catch (e) {
          console.error("Failed to fetch history:", e);
        }
      }

      function refreshCharts() {
        fetchHistory(24, chart24h);
        fetchHistory(672, chart28d);
      }

      refreshCharts();
      setInterval(refreshCharts, 60000);

      function connect() {
        const ws = new WebSocket(location.origin.replace("http", "ws") + "/ws");

        ws.onopen = () => {
          connectedAt = Date.now();
          statusIndicator.textContent = "Connected";
          statusEl.className = "status connected";
          statusDuration.textContent = "0s";
        };

        ws.onclose = () => {
          connectedAt = null;
          statusIndicator.textContent = "Disconnected";
          statusEl.className = "status disconnected";
          statusDuration.textContent = "";
          setTimeout(connect, 1000);
        };

        ws.onmessage = (e) => {
          const stats = JSON.parse(e.data);
          labelA.textContent = stats.stream_a_name;
          labelB.textContent = stats.stream_b_name;
          countA.textContent = stats.stream_a.toLocaleString();
          countB.textContent = stats.stream_b.toLocaleString();
          rateA.textContent = Math.round(stats.rate_a).toLocaleString() + "/s";
          rateB.textContent = Math.round(stats.rate_b).toLocaleString() + "/s";

          const delta = stats.delta;
          deltaValue.textContent =
            delta > 0 ? "+" + delta.toLocaleString() : delta.toLocaleString();

          if (delta > 0) {
            deltaEl.className = "delta positive";
          } else if (delta < 0) {
            deltaEl.className = "delta negative";
          } else {
            deltaEl.className = "delta neutral";
          }
        };
      }

      connect();
    </script>
  </body>
</html>
