<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bluesky Stream Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      :root {
        --bg-primary: #0d0d0d;
        --bg-card: #141414;
        --bg-card-hover: #181818;
        --border-subtle: #252525;
        --border-accent: #333;
        --text-primary: #e5e5e5;
        --text-secondary: #737373;
        --text-muted: #525252;
        --accent-green: #22c55e;
        --accent-red: #ef4444;
        --accent-blue: #3b82f6;
        --accent-yellow: #eab308;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 2rem;
        line-height: 1.5;
      }
      .header {
        text-align: center;
        margin-bottom: 2.5rem;
      }
      .header h1 {
        font-size: 1.75rem;
        font-weight: 600;
        letter-spacing: -0.025em;
        margin-bottom: 0.5rem;
      }
      .header p {
        color: var(--text-secondary);
        font-size: 0.9375rem;
      }
      .live-counters {
        display: flex;
        flex-wrap: nowrap;
        gap: 1.25rem;
        justify-content: center;
        align-items: stretch;
        margin: 0 auto 2rem auto;
        max-width: 800px;
      }
      .session-label {
        width: 100%;
        text-align: center;
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.5rem;
        flex-shrink: 0;
      }
      .counter {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 1.75rem 1.5rem;
        text-align: center;
        border: 1px solid var(--border-subtle);
        flex: 1 1 0;
        min-width: 0;
        transition: border-color 0.2s ease;
      }
      .counter .label {
        font-size: 0.8125rem;
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .counter .value {
        font-size: 2.5rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        letter-spacing: -0.03em;
        line-height: 1.1;
      }
      .counter .rate {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 0.5rem;
        font-variant-numeric: tabular-nums;
      }
      .counter .stats-row {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-subtle);
      }
      .counter .stat-item {
        font-size: 0.6875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .counter .stat-value {
        color: var(--text-primary);
        font-weight: 600;
        display: block;
        font-size: 0.875rem;
        margin-bottom: 0.125rem;
      }
      .counter .stat-value.good {
        color: var(--accent-green);
      }
      .counter .stat-value.warning {
        color: var(--accent-yellow);
      }
      .counter .stat-value.bad {
        color: var(--accent-red);
      }
      .counter .connection-status {
        font-size: 0.6875rem;
        margin-top: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .counter .connection-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--accent-green);
        margin-right: 6px;
        vertical-align: middle;
      }
      .counter .connection-dot.disconnected {
        background: var(--accent-red);
      }
      .counter .connection-status.connected {
        color: var(--accent-green);
      }
      .counter .connection-status.disconnected {
        color: var(--accent-red);
      }
      .delta {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        flex: 0 0 100px;
        min-width: 100px;
        min-width: 180px;
      }
      .delta .value {
        font-variant-numeric: tabular-nums;
      }
      .delta .label {
        font-size: 0.6875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.25rem;
      }
      .delta .value {
        font-size: 1.5rem;
        font-weight: 600;
      }
      .delta.positive .value {
        color: var(--accent-green);
      }
      .delta.negative .value {
        color: var(--accent-red);
      }
      .delta.neutral .value {
        color: var(--text-secondary);
      }

      .section-title {
        font-size: 0.8125rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.15em;
        margin: 2.5rem 0 1.25rem 0;
        text-align: center;
        font-weight: 500;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
        max-width: 1200px;
        margin: 0 auto 2rem auto;
      }

      .metric-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 1.25rem;
      }
      .metric-card h3 {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
        font-weight: 500;
      }
      .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-subtle);
      }
      .metric-row:last-child {
        border-bottom: none;
      }
      .metric-label {
        font-size: 0.8125rem;
        color: var(--text-secondary);
      }
      .metric-value {
        font-size: 0.9rem;
        font-weight: 600;
        font-variant-numeric: tabular-nums;
      }
      .metric-value.good {
        color: var(--accent-green);
      }
      .metric-value.warning {
        color: var(--accent-yellow);
      }
      .metric-value.bad {
        color: var(--accent-red);
      }

      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.25rem;
        max-width: 1200px;
        margin: 0 auto;
      }
      .chart-panel {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid var(--border-subtle);
      }
      .chart-panel h2 {
        font-size: 0.8125rem;
        font-weight: 500;
        margin-bottom: 1rem;
        color: var(--text-secondary);
      }
      .chart-wrapper {
        height: 180px;
        position: relative;
        width: 100%;
      }

      .status {
        position: fixed;
        bottom: 1.25rem;
        right: 1.25rem;
        padding: 0.375rem 0.875rem;
        border-radius: 9999px;
        font-size: 0.6875rem;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .status .duration {
        font-size: 0.625rem;
        color: var(--text-muted);
      }
      .status.connected {
        color: var(--accent-green);
      }
      .status.disconnected {
        color: var(--accent-red);
      }

      @media (max-width: 768px) {
        body {
          padding: 1.25rem;
        }
        .live-counters {
          flex-direction: column;
          gap: 1rem;
        }
        .counter,
        .delta {
          flex: 1 1 100%;
          width: 100%;
        }
        .charts-container {
          grid-template-columns: 1fr;
        }
        .chart-panel {
          min-width: 0;
        }
        .chart-wrapper {
          height: 160px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Stream Monitor</h1>
      <p>Real-time Bluesky Jetstream monitoring</p>
    </div>

    <div class="session-label">Live Metrics</div>
    <div class="live-counters">
      <div class="counter" id="counter-a">
        <div class="label" id="label-a">Stream A</div>
        <div class="value" id="count-a">0</div>
        <div class="rate" id="rate-a">0/s</div>
        <div class="stats-row">
          <div class="stat-item">
            <span class="stat-value" id="streak-a">-</span>
            Streak
          </div>
          <div class="stat-item">
            <span class="stat-value" id="uptime-a">-</span>
            Uptime
          </div>
        </div>
        <div class="connection-status connected" id="conn-status-a">
          ● Connected
        </div>
      </div>

      <div class="delta neutral" id="delta">
        <div class="label">Delta</div>
        <div class="value" id="delta-value">0</div>
      </div>

      <div class="counter" id="counter-b">
        <div class="label" id="label-b">Stream B</div>
        <div class="value" id="count-b">0</div>
        <div class="rate" id="rate-b">0/s</div>
        <div class="stats-row">
          <div class="stat-item">
            <span class="stat-value" id="streak-b">-</span>
            Streak
          </div>
          <div class="stat-item">
            <span class="stat-value" id="uptime-b">-</span>
            Uptime
          </div>
        </div>
        <div class="connection-status connected" id="conn-status-b">
          ● Connected
        </div>
      </div>
    </div>

    <div class="section-title">Uptime Dashboard</div>
    <div class="metrics-grid">
      <div class="metric-card">
        <h3>24-Hour Summary</h3>
        <div class="metric-row">
          <span class="metric-label" id="uptime24-label-a"
            >Stream A Uptime</span
          >
          <span class="metric-value good" id="uptime24-a">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime24-label-b"
            >Stream B Uptime</span
          >
          <span class="metric-value good" id="uptime24-b">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime24-total-label-a"
            >Stream A Total Up</span
          >
          <span class="metric-value" id="uptime24-total-a">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime24-total-label-b"
            >Stream B Total Up</span
          >
          <span class="metric-value" id="uptime24-total-b">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime24-disc-label-a"
            >Stream A Disconnects</span
          >
          <span class="metric-value" id="uptime24-disc-a">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime24-disc-label-b"
            >Stream B Disconnects</span
          >
          <span class="metric-value" id="uptime24-disc-b">-</span>
        </div>
      </div>

      <div class="metric-card">
        <h3>28-Day Summary</h3>
        <div class="metric-row">
          <span class="metric-label" id="uptime28-label-a"
            >Stream A Uptime</span
          >
          <span class="metric-value good" id="uptime28-a">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime28-label-b"
            >Stream B Uptime</span
          >
          <span class="metric-value good" id="uptime28-b">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime28-total-label-a"
            >Stream A Total Up</span
          >
          <span class="metric-value" id="uptime28-total-a">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime28-total-label-b"
            >Stream B Total Up</span
          >
          <span class="metric-value" id="uptime28-total-b">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime28-disc-label-a"
            >Stream A Disconnects</span
          >
          <span class="metric-value" id="uptime28-disc-a">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="uptime28-disc-label-b"
            >Stream B Disconnects</span
          >
          <span class="metric-value" id="uptime28-disc-b">-</span>
        </div>
      </div>

      <div class="metric-card">
        <h3>Message Rate (24h)</h3>
        <div class="metric-row">
          <span class="metric-label" id="rate24-label-a">Stream A Avg</span>
          <span class="metric-value" id="rate24-a">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="rate24-label-b">Stream B Avg</span>
          <span class="metric-value" id="rate24-b">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="msgs24-label-a">Stream A Total Msgs</span>
          <span class="metric-value" id="msgs24-a">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label" id="msgs24-label-b">Stream B Total Msgs</span>
          <span class="metric-value" id="msgs24-b">-</span>
        </div>
      </div>
    </div>

    <div class="charts-container">
      <div class="chart-panel">
        <h2 id="uptime-chart-24h-title">Uptime % (24h)</h2>
        <div class="chart-wrapper">
          <canvas id="chart-uptime-24h"></canvas>
        </div>
      </div>
      <div class="chart-panel">
        <h2 id="uptime-chart-28d-title">Uptime % (28 days)</h2>
        <div class="chart-wrapper">
          <canvas id="chart-uptime-28d"></canvas>
        </div>
      </div>
      <div class="chart-panel">
        <h2 id="rate-chart-24h-title">Message Rate (24h)</h2>
        <div class="chart-wrapper">
          <canvas id="chart-rate-24h"></canvas>
        </div>
      </div>
    </div>

    <div class="status disconnected" id="status">
      <span class="indicator">Disconnected</span>
      <span class="duration" id="status-duration"></span>
    </div>

    <script>
      const labelA = document.getElementById("label-a");
      const labelB = document.getElementById("label-b");
      const countA = document.getElementById("count-a");
      const countB = document.getElementById("count-b");
      const rateA = document.getElementById("rate-a");
      const rateB = document.getElementById("rate-b");
      const streakA = document.getElementById("streak-a");
      const streakB = document.getElementById("streak-b");
      const uptimeA = document.getElementById("uptime-a");
      const uptimeB = document.getElementById("uptime-b");
      const connStatusA = document.getElementById("conn-status-a");
      const connStatusB = document.getElementById("conn-status-b");
      const deltaEl = document.getElementById("delta");
      const deltaValue = document.getElementById("delta-value");
      const statusEl = document.getElementById("status");
      const statusIndicator = statusEl.querySelector(".indicator");
      const statusDuration = document.getElementById("status-duration");

      let connectedAt = null;
      let streamAName = "Stream A";
      let streamBName = "Stream B";
      let rawData24h = [];
      let rawData28d = [];
      let uptimeData24h = [];
      let uptimeData28d = [];
      let rawUptimeData24h = [];
      let rawUptimeData28d = [];

      function formatDuration(ms) {
        const secs = Math.floor(ms / 1000);
        const hrs = Math.floor(secs / 3600);
        const mins = Math.floor((secs % 3600) / 60);
        if (hrs > 0) return `${hrs}h ${mins}m`;
        if (mins > 0) return `${mins}m ${secs % 60}s`;
        return `${secs}s`;
      }

      function formatDurationLong(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        if (hrs > 0) return `${hrs}h ${mins}m ${secs}s`;
        if (mins > 0) return `${mins}m ${secs}s`;
        return `${secs}s`;
      }

      function formatUptimePercentage(basisPoints) {
        const percentage = basisPoints / 100;
        return percentage.toFixed(2) + "%";
      }

      function getUptimeClass(percentage) {
        if (percentage >= 99) return "good";
        if (percentage >= 95) return "warning";
        return "bad";
      }

      function calculate24hStats(data) {
        if (data.length === 0) return;

        let totalA = 0,
          totalB = 0;
        let disconnectsA = 0,
          disconnectsB = 0;
        let messagesA = 0,
          messagesB = 0;

        data.forEach((d) => {
          totalA += d.stream_a_seconds || 0;
          totalB += d.stream_b_seconds || 0;
          disconnectsA += d.stream_a_disconnects || 0;
          disconnectsB += d.stream_b_disconnects || 0;
          messagesA += d.stream_a_messages || 0;
          messagesB += d.stream_b_messages || 0;
        });

        const uptimeA = (totalA / (24 * 3600)) * 100;
        const uptimeB = (totalB / (24 * 3600)) * 100;

        const el = (id, val) => document.getElementById(id);
        el("uptime24-a").textContent = uptimeA.toFixed(2) + "%";
        el("uptime24-b").textContent = uptimeB.toFixed(2) + "%";
        el("uptime24-a").className = "metric-value " + getUptimeClass(uptimeA);
        el("uptime24-b").className = "metric-value " + getUptimeClass(uptimeB);

        el("uptime24-total-a").textContent = formatDurationLong(totalA);
        el("uptime24-total-b").textContent = formatDurationLong(totalB);

        el("uptime24-disc-a").textContent = disconnectsA;
        el("uptime24-disc-b").textContent = disconnectsB;

        if (messagesA > 0 && totalA > 0) {
          el("rate24-a").textContent = (messagesA / totalA).toFixed(1) + "/s";
        }
        if (messagesB > 0 && totalB > 0) {
          el("rate24-b").textContent = (messagesB / totalB).toFixed(1) + "/s";
        }

        el("msgs24-a").textContent = messagesA.toLocaleString();
        el("msgs24-b").textContent = messagesB.toLocaleString();
      }

      setInterval(() => {
        if (connectedAt) {
          statusDuration.textContent = formatDuration(Date.now() - connectedAt);
        }
      }, 1000);

      function updateLabels() {
        document.getElementById("uptime24-label-a").textContent =
          streamAName + " Uptime";
        document.getElementById("uptime24-label-b").textContent =
          streamBName + " Uptime";
        document.getElementById("uptime24-total-label-a").textContent =
          streamAName + " Total Up";
        document.getElementById("uptime24-total-label-b").textContent =
          streamBName + " Total Up";
        document.getElementById("uptime24-disc-label-a").textContent =
          streamAName + " Disconnects";
        document.getElementById("uptime24-disc-label-b").textContent =
          streamBName + " Disconnects";
        document.getElementById("uptime28-label-a").textContent =
          streamAName + " Uptime";
        document.getElementById("uptime28-label-b").textContent =
          streamBName + " Uptime";
        document.getElementById("uptime28-total-label-a").textContent =
          streamAName + " Total Up";
        document.getElementById("uptime28-total-label-b").textContent =
          streamBName + " Total Up";
        document.getElementById("uptime28-disc-label-a").textContent =
          streamAName + " Disconnects";
        document.getElementById("uptime28-disc-label-b").textContent =
          streamBName + " Disconnects";
        document.getElementById("rate24-label-a").textContent =
          streamAName + " Avg";
        document.getElementById("rate24-label-b").textContent =
          streamBName + " Avg";
        document.getElementById("msgs24-label-a").textContent =
          streamAName + " Total Msgs";
        document.getElementById("msgs24-label-b").textContent =
          streamBName + " Total Msgs";
      }

      function createUptimeChart(canvasId, titleId, title) {
        return new Chart(document.getElementById(canvasId), {
          type: "bar",
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: { color: "#888", boxWidth: 12 },
              },
              tooltip: {
                backgroundColor: "#2a2a2a",
                titleColor: "#e0e0e0",
                bodyColor: "#888",
              },
            },
            scales: {
              x: {
                ticks: { color: "#666", maxTicksLimit: 12 },
                grid: { display: false },
              },
              y: {
                ticks: { color: "#666", callback: (v) => v + "%" },
                grid: { color: "#222" },
                min: 0,
                max: 100,
              },
            },
          },
        });
      }

      function createRateChart(canvasId, titleId, title) {
        return new Chart(document.getElementById(canvasId), {
          type: "line",
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: { color: "#888", boxWidth: 12 },
              },
              tooltip: {
                backgroundColor: "#2a2a2a",
                titleColor: "#e0e0e0",
                bodyColor: "#888",
              },
            },
            scales: {
              x: {
                ticks: { color: "#666", maxTicksLimit: 12 },
                grid: { display: false },
              },
              y: {
                ticks: { color: "#666", callback: (v) => v + "/s" },
                grid: { color: "#222" },
              },
            },
          },
        });
      }

      const chartUptime24h = createUptimeChart(
        "chart-uptime-24h",
        "uptime-chart-24h-title",
        "Uptime % (24h)",
      );
      const chartUptime28d = createUptimeChart(
        "chart-uptime-28d",
        "uptime-chart-28d-title",
        "Uptime % (28 days)",
      );
      const chartRate24h = createRateChart(
        "chart-rate-24h",
        "rate-chart-24h-title",
        "Message Rate (24h)",
      );

      async function fetchUptimeHistory(hours, uptimeChart, rateChart) {
        try {
          const res = await fetch(`/api/uptime?hours=${hours}`);
          const data = await res.json();

          if (data.length === 0) return;

          const labels = data.map((d) => {
            const date = new Date(d.hour);
            return hours <= 24
              ? date.toLocaleString("en-US", {
                  month: "short",
                  day: "numeric",
                  hour: "2-digit",
                })
              : date.toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                });
          });

          const uptimeA = data.map((d) => (d.stream_a_seconds / 3600) * 100);
          const uptimeB = data.map((d) => (d.stream_b_seconds / 3600) * 100);

          if (uptimeChart && hours <= 24) {
            uptimeChart.data.labels = labels;
            uptimeChart.data.datasets = [
              {
                label: streamAName,
                data: uptimeA,
                backgroundColor: "rgba(34, 197, 94, 0.7)",
                borderColor: "#22c55e",
                borderWidth: 1,
              },
              {
                label: streamBName,
                data: uptimeB,
                backgroundColor: "rgba(59, 130, 246, 0.7)",
                borderColor: "#3b82f6",
                borderWidth: 1,
              },
            ];
            uptimeChart.update("none");
          } else if (uptimeChart) {
            const dailyUptime = {};
            data.forEach((d) => {
              const day = new Date(d.hour).toISOString().split("T")[0];
              if (!dailyUptime[day])
                dailyUptime[day] = { a: 0, b: 0, count: 0 };
              dailyUptime[day].a += d.stream_a_seconds;
              dailyUptime[day].b += d.stream_b_seconds;
              dailyUptime[day].count++;
            });
            const days = Object.keys(dailyUptime).slice(-28);
            uptimeChart.data.labels = days;
            uptimeChart.data.datasets = [
              {
                label: streamAName,
                data: days.map(
                  (d) =>
                    (dailyUptime[d].a / (dailyUptime[d].count * 3600)) * 100,
                ),
                backgroundColor: "rgba(34, 197, 94, 0.7)",
                borderColor: "#22c55e",
                borderWidth: 1,
              },
              {
                label: streamBName,
                data: days.map(
                  (d) =>
                    (dailyUptime[d].b / (dailyUptime[d].count * 3600)) * 100,
                ),
                backgroundColor: "rgba(59, 130, 246, 0.7)",
                borderColor: "#3b82f6",
                borderWidth: 1,
              },
            ];
            uptimeChart.update("none");
          }

          if (rateChart && hours <= 24) {
            const messagesA = data.map((d) => d.stream_a_messages || 0);
            const messagesB = data.map((d) => d.stream_b_messages || 0);
            rateChart.data.labels = labels;
            rateChart.data.datasets = [
              {
                label: streamAName,
                data: messagesA.map((m, i) => m / 3600),
                borderColor: "#22c55e",
                backgroundColor: "transparent",
                tension: 0.3,
              },
              {
                label: streamBName,
                data: messagesB.map((m, i) => m / 3600),
                borderColor: "#3b82f6",
                backgroundColor: "transparent",
                tension: 0.3,
              },
            ];
            rateChart.update("none");
          }

          if (hours <= 24) {
            rawUptimeData24h = data;
            calculate24hStats(data);
          } else {
            rawUptimeData28d = data;
          }
        } catch (e) {
          console.error("Failed to fetch uptime history:", e);
        }
      }

      function refreshData() {
        fetchUptimeHistory(24, chartUptime24h, chartRate24h);
        fetchUptimeHistory(672, chartUptime28d, null);
      }

      refreshData();
      setInterval(refreshData, 60000);

      function connect() {
        const ws = new WebSocket(location.origin.replace("http", "ws") + "/ws");

        ws.onopen = () => {
          connectedAt = Date.now();
          statusIndicator.textContent = "Connected";
          statusEl.className = "status connected";
          statusDuration.textContent = "0s";
        };

        ws.onclose = () => {
          connectedAt = null;
          statusIndicator.textContent = "Disconnected";
          statusEl.className = "status disconnected";
          statusDuration.textContent = "";
          setTimeout(connect, 1000);
        };

        ws.onmessage = (e) => {
          const stats = JSON.parse(e.data);

          if (
            streamAName !== stats.stream_a_name ||
            streamBName !== stats.stream_b_name
          ) {
            streamAName = stats.stream_a_name;
            streamBName = stats.stream_b_name;
            labelA.textContent = streamAName;
            labelB.textContent = streamBName;
            updateLabels();
          }

          labelA.textContent = stats.stream_a_name;
          labelB.textContent = stats.stream_b_name;
          countA.textContent = stats.stream_a.toLocaleString();
          countB.textContent = stats.stream_b.toLocaleString();
          rateA.textContent = Math.round(stats.rate_a).toLocaleString() + "/s";
          rateB.textContent = Math.round(stats.rate_b).toLocaleString() + "/s";

          const uptimePercentA = formatUptimePercentage(stats.uptime_a);
          const uptimePercentB = formatUptimePercentage(stats.uptime_b);
          uptimeA.textContent = uptimePercentA;
          uptimeB.textContent = uptimePercentB;

          streakA.textContent = formatDuration(stats.current_streak_a * 1000);
          streakB.textContent = formatDuration(stats.current_streak_b * 1000);

          if (stats.connected_a) {
            connStatusA.textContent = "● Connected";
            connStatusA.className = "connection-status connected";
            uptimeA.className = "stat-value good";
          } else {
            connStatusA.textContent = "⏸ Disconnected";
            connStatusA.className = "connection-status disconnected";
            uptimeA.className = "stat-value bad";
          }

          if (stats.connected_b) {
            connStatusB.textContent = "● Connected";
            connStatusB.className = "connection-status connected";
            uptimeB.className = "stat-value good";
          } else {
            connStatusB.textContent = "⏸ Disconnected";
            connStatusB.className = "connection-status disconnected";
            uptimeB.className = "stat-value bad";
          }

          const delta = stats.delta;
          const sign = delta >= 0 ? "+" : "";
          deltaValue.textContent = sign + delta.toLocaleString();

          if (delta > 0) {
            deltaEl.className = "delta positive";
          } else if (delta < 0) {
            deltaEl.className = "delta negative";
          } else {
            deltaEl.className = "delta neutral";
          }
        };
      }

      connect();
    </script>
  </body>
</html>
