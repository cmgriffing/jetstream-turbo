name: Deploy Turbo to VPS

on:
  push:
    branches: [main, master]
    paths:
      - "rust/**"
      - ".github/workflows/deploy-turbo.yml"
  workflow_dispatch:
    inputs:
      target:
        description: "Target architecture (e.g., x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu)"
        required: false
        default: "x86_64-unknown-linux-musl"

env:
  CARGO_TERM_COLOR: always
  TARGET: ${{ github.event.inputs.target || 'x86_64-unknown-linux-musl' }}
  DEPLOY_PATH: /opt/jetstream-turbo
  SERVICE_NAME: jetstream-turbo
  BINARY_NAME: jetstream-turbo

jobs:
  build:
    name: Build Release Binary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cross
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cross
          key: ${{ runner.os }}-cross-bin

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          # Since your Cargo.toml is in the 'rust' subfolder
          workspaces: "rust -> target"

      - name: Build release binary
        working-directory: rust
        run: cross build --release --target ${{ env.TARGET }}

      - name: Strip binary
        run: strip rust/target/${{ env.TARGET }}/release/${{ env.BINARY_NAME }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-turbo-${{ env.TARGET }}
          path: rust/target/${{ env.TARGET }}/release/${{ env.BINARY_NAME }}
          retention-days: 1

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: binary-turbo-${{ env.TARGET }}

      - name: Create directories on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          script: |
            ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
              sudo mkdir -p ${{ env.DEPLOY_PATH }}
              sudo useradd -r -s /bin/false ${{ env.SERVICE_NAME }} 2>/dev/null || true
              sudo chown ${{ env.SERVICE_NAME }}:${{ env.SERVICE_NAME }} ${{ env.DEPLOY_PATH }}
            "

      - name: Copy binary to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          source: ${{ env.BINARY_NAME }}
          target: "/tmp/${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}"

      - name: Update binary permissions on Host
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          script: |
            sudo mv /tmp/${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }} ${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}
            sudo chmod +x ${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}
            sudo chown ${{ env.SERVICE_NAME }}:${{ env.SERVICE_NAME }} ${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}

      - name: Copy systemd service file to Host
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          source: rust/deploy/systemd/${{ env.SERVICE_NAME }}.service
          target: "/tmp/${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}"

      - name: Move systemd service file and reload via systemctl
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          script: |
            sudo mv /tmp/${{ env.SERVICE_NAME }}.service /etc/systemd/system/${{ env.SERVICE_NAME }}.service
            sudo systemctl daemon-reload

      - name: Check for .env file
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          script: |
            if [ ! -f ${{ env.DEPLOY_PATH }}/.env ]; then
              echo '# Create .env file at ${{ env.DEPLOY_PATH }}/.env with your configuration'
              echo '# Required: BLUESKY_HANDLE, BLUESKY_APP_PASSWORD, STREAM_NAME'
              echo '# You will need to restart the service after updating the .env file.'
              echo '# sudo systemctl restart ${{ env.SERVICE_NAME }}'
            fi

      - name: Restart Service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          script: |
            sudo systemctl enable ${{ env.SERVICE_NAME }}
            sudo systemctl restart ${{ env.SERVICE_NAME }}

      - name: Copy Caddy setup script to Host
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          source: rust/deploy/setup-caddy.sh
          target: "/tmp/${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}"

      - name: Execute Caddy setup script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          script: |
            sudo bash /tmp/setup-caddy.sh

      - name: Verify deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_TURBO_HOST }}
          username: deploy
          key: ${{ secrets.VPS_TURBO_SSH_KEY }}
          script: |
            sleep 3
            sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager
            curl -sf http://localhost:8080/api/v1/health || echo 'Health check failed - service may still be starting'
