name: Deploy Turbo to VPS

on:
  push:
    branches: [main, master]
    paths:
      - "rust/**"
      - ".github/workflows/deploy-turbo.yml"
  workflow_dispatch:
    inputs:
      target:
        description: "Target architecture (e.g., x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu)"
        required: false
        default: "x86_64-unknown-linux-gnu"

env:
  CARGO_TERM_COLOR: always
  TARGET: ${{ github.event.inputs.target || 'x86_64-unknown-linux-gnu' }}
  DEPLOY_PATH: /opt/jetstream-turbo
  SERVICE_NAME: jetstream-turbo
  BINARY_NAME: jetstream-turbo

jobs:
  build:
    name: Build Release Binary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GCC 11
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-11 g++-11
          echo "CC=gcc-11" >> $GITHUB_ENV
          echo "CXX=g++-11" >> $GITHUB_ENV

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Build release binary
        working-directory: rust
        run: cross build --release --target ${{ env.TARGET }}

      - name: Strip binary
        run: strip rust/target/${{ env.TARGET }}/release/${{ env.BINARY_NAME }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-turbo-${{ env.TARGET }}
          path: rust/target/${{ env.TARGET }}/release/${{ env.BINARY_NAME }}
          retention-days: 1

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: binary-turbo-${{ env.TARGET }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_TURBO_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_TURBO_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create directories on VPS
        env:
          SSH_HOST: ${{ secrets.VPS_TURBO_HOST }}
          SSH_USER: ${{ secrets.VPS_TURBO_USER }}
          SSH_PORT: ${{ secrets.VPS_TURBO_PORT || '22' }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            sudo mkdir -p ${{ env.DEPLOY_PATH }}
            sudo useradd -r -s /bin/false ${{ env.SERVICE_NAME }} 2>/dev/null || true
            sudo chown ${{ env.SERVICE_NAME }}:${{ env.SERVICE_NAME }} ${{ env.DEPLOY_PATH }}
          "

      - name: Copy binary to VPS
        env:
          SSH_HOST: ${{ secrets.VPS_TURBO_HOST }}
          SSH_USER: ${{ secrets.VPS_TURBO_USER }}
          SSH_PORT: ${{ secrets.VPS_TURBO_PORT || '22' }}
        run: |
          scp -P $SSH_PORT ${{ env.BINARY_NAME }} $SSH_USER@$SSH_HOST:/tmp/${{ env.BINARY_NAME }}
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            sudo cp /tmp/${{ env.BINARY_NAME }} ${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}
            sudo chmod +x ${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}
            sudo chown ${{ env.SERVICE_NAME }}:${{ env.SERVICE_NAME }} ${{ env.DEPLOY_PATH }}/${{ env.BINARY_NAME }}
          "

      - name: Copy systemd service file
        env:
          SSH_HOST: ${{ secrets.VPS_TURBO_HOST }}
          SSH_USER: ${{ secrets.VPS_TURBO_USER }}
          SSH_PORT: ${{ secrets.VPS_TURBO_PORT || '22' }}
        run: |
          scp -P $SSH_PORT rust/deploy/systemd/${{ env.SERVICE_NAME }}.service $SSH_USER@$SSH_HOST:/tmp/${{ env.SERVICE_NAME }}.service
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            sudo cp /tmp/${{ env.SERVICE_NAME }}.service /etc/systemd/system/${{ env.SERVICE_NAME }}.service
            sudo systemctl daemon-reload
          "

      - name: Copy .env.example if not exists
        env:
          SSH_HOST: ${{ secrets.VPS_TURBO_HOST }}
          SSH_USER: ${{ secrets.VPS_TURBO_USER }}
          SSH_PORT: ${{ secrets.VPS_TURBO_PORT || '22' }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            if [ ! -f ${{ env.DEPLOY_PATH }}/.env ]; then
              echo '# Create .env file at ${{ env.DEPLOY_PATH }}/.env with your configuration'
              echo '# Required: BLUESKY_HANDLE, BLUESKY_APP_PASSWORD, STREAM_NAME'
            fi
          "

      - name: Restart service
        env:
          SSH_HOST: ${{ secrets.VPS_TURBO_HOST }}
          SSH_USER: ${{ secrets.VPS_TURBO_USER }}
          SSH_PORT: ${{ secrets.VPS_TURBO_PORT || '22' }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            sudo systemctl enable ${{ env.SERVICE_NAME }}
            sudo systemctl restart ${{ env.SERVICE_NAME }}
          "

      - name: Setup Caddy reverse proxy
        env:
          SSH_HOST: ${{ secrets.VPS_TURBO_HOST }}
          SSH_USER: ${{ secrets.VPS_TURBO_USER }}
          SSH_PORT: ${{ secrets.VPS_TURBO_PORT || '22' }}
        run: |
          scp -P $SSH_PORT rust/deploy/setup-caddy.sh $SSH_USER@$SSH_HOST:/tmp/setup-caddy.sh
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "sudo bash /tmp/setup-caddy.sh"

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.VPS_TURBO_HOST }}
          SSH_USER: ${{ secrets.VPS_TURBO_USER }}
          SSH_PORT: ${{ secrets.VPS_TURBO_PORT || '22' }}
        run: |
          ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
            sleep 3
            sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager
            curl -sf http://localhost:8080/api/v1/health || echo 'Health check failed - service may still be starting'
          "
